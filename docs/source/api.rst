.. py:module:: network_tester

The Network Tester API
------------------------

The :py:class:`Experiment` Class
````````````````````````````````

.. autoclass:: Experiment()
    :members: __init__, new_vertex, new_net, new_group, run, place_and_route,
              placements, allocations, routes

Experimental Parameters
```````````````````````

Global
~~~~~~

The following experimental parameters apply globally and cannot be overridden
on a vertex-by-vertex or net-by-net basis. They can be changed between groups.

.. attribute:: Experiment.timestep

    The timestep (in seconds) with which packets are generated by any packet
    generators in the experiment. 
    
    Default value: 0.001 (i.e. 1 ms)
    
    All timing related parameters (e.g. :py:attr:`~Experiment.duration` and
    :py:attr:`~Experiment.record_interval`) are internally converted into
    multiples of this timestep and rounded to the nearest number of steps 
    
    .. warning::
        Setting this value too small will result in the traffic generator
        software being unable to meet timing deadlines and thus the experiment
        failing. In practice, 1.5 us is the smallest this can be set but larger
        values are required if any vertex is the source of many nets or if
        large numbers of metrics are being recorded.

.. attribute:: Experiment.duration

    The duration (in seconds) to run the traffic generators and record results
    for each experimental group.
    
    Default value: 1.0
    
    See also: :py:attr:`~Experiment.warmup`, :py:attr:`~Experiment.cooldown` and
    :py:attr:`Experiment.flush_time`.

.. attribute:: Experiment.warmup

    The duration (in seconds) to run the traffic generators without recording
    results before beginning result recording for each experimental group.
    
    Default value: 0.0
    
    Many experiments require the network to be in a stable state for their
    results to be meaningful. To achieve this, a warmup period can be specified
    during which time the network is allowed to settle into a stable state
    before any results are recorded.
    
    See also: :py:attr:`~Experiment.duration`, :py:attr:`~Experiment.cooldown` and
    :py:attr:`~Experiment.flush_time`.

.. attribute:: Experiment.cooldown

    The duration (in seconds) to run the traffic generators without recording
    results after result recording is completed for each experimental group.
    
    Default value: 0.0
    
    Since the clocks in individual SpiNNaker cores are not perfectly in sync
    (and can drift significantly during long-duration experimental groups), it
    may be necessary for traffic generators to continue producing traffic for a
    short time after their local timer indicates the end of the experiment in
    order to maintain consistent network load for any traffic generators which
    are still running.
    
    See also: :py:attr:`~Experiment.duration`, :py:attr:`~Experiment.warmup` and
    :py:attr:`~Experiment.flush_time`.

.. attribute:: Experiment.flush_time

    The pause (in seconds) which is added between experimental groups to allow
    any packets which remain in the network to be drained.
    
    Default value: 0.01
    
    This is especially important when :py:attr:`~Experiment.consume_packets` has
    been set to False.
    
    See also: :py:attr:`~Experiment.duration`, :py:attr:`~Experiment.warmup` and
    :py:attr:`~Experiment.cooldown`.

.. attribute:: Experiment.record_interval

    The interval (in seconds) at which metrics are recorded during an experiment.
    
    Default value: 0.0
    
    Special case: If zero, metrics will be recorded once at the end each
    group's execution.

.. attribute:: Experiment.router_timeout

    Sets the router timeout (in router clock cycles at (usually) 133MHz).
    
    Default value: None (do not change)
    
    If set to an integer, this sets the number of clock cycles before a packet
    times out and is dropped. :py:meth:`Experiment.run` will throw a
    :py:exc:`ValueError` if the value presented is not a valid router timeout.
    Emergency routing will be disabled.
    
    If set to a tuple (wait1, wait2), wait1 sets the number of clock cycles
    before emergency routing is tried and wait2 gives the number of additional
    cycles before the packet is dropped. :py:meth:`Experiment.run` will throw a
    :py:exc:`ValueError` if the values presented are not valid router timeouts.
    
    If None, the timeout will be left as the default when the system was
    booted.
    
    If this field is set to anything other than None at any point during the
    experiment, a single vertex on every chip will be used to set the router
    timeout. This may result in new vertices being created internally and
    placed on otherwise unused chips.


Metric Recording Selection
~~~~~~~~~~~~~~~~~~~~~~~~~~

The following boolean attributes control what metrics are recorded during an
experiment. Note that the set of recorded metrics may not be changed during an
experiment (though the recording interval can, see
:py:attr:`Experiment.record_interval`.

By default, no metrics are recorded.


.. attribute:: Experiment.record_local_multicast
               Experiment.record_external_multicast
               Experiment.record_local_p2p
               Experiment.record_external_p2p
               Experiment.record_local_nearest_neighbour
               Experiment.record_external_nearest_neighbour
               Experiment.record_local_fixed_route
               Experiment.record_external_fixed_route
               Experiment.record_dropped_multicast
               Experiment.record_dropped_p2p
               Experiment.record_dropped_nearest_neighbour
               Experiment.record_dropped_fixed_route
               Experiment.record_counter12
               Experiment.record_counter13
               Experiment.record_counter14
               Experiment.record_counter15
    
    Record changes in each of the SpiNNaker router counter registers.
    
    If any of these metrics are recorded, a single vertex on every chip will be
    configured accordingly ensuring router counter values are recorded for all
    chips in the machine. This may result in new vertices being created
    internally and placed on otherwise unused chips.


.. attribute:: Experiment.record_sent
    
    Record the number of packets successfully sent for each net.


.. attribute:: Experiment.record_blocked
    
    Record the number of packets which could not be sent for each net due to
    back-pressure from the network. Note that blocked packets are not resent.


.. attribute:: Experiment.record_received
    
    Record the number of packets received at each sink of each net.

.. _net-attributes:

Net
~~~

The following experimental parameters apply to each net in the experiment.
These control the pattern of packets generated and sent down each net.

The global default for each value can be set by setting the corresponding
:py:class:`Experiment` attribute.

The default for nets sourced by a particular vertex can be set by setting the
corresponding :py:class:`Vertex` attribute.

These values may also be overridden on a group-by-group basis.

For example::

    >>> e = Experiment(...)
    >>> v0 = e.new_vertex()
    >>> v1 = e.new_vertex()
    >>> v2 = e.new_vertex()
    >>> n0 = e.new_net(v0, v1)
    >>> n1 = e.new_net(v0, v3)
    >>> n2 = e.new_net(v2, v3)
    
    >>> e.probability = 1.0
    >>> v0.probability = 0.9
    >>> n0.probability = 0.8
    
    >>> # First group: n0, n1, n2 all have probability == 0.0
    >>> with e.new_group():
    ...     e.probability = 0.0
    ...     v0.probability = 0.0
    ...     n0.probability = 0.0
    
    >>> # Second group: n2 has probability == 0.1 but n0 and n1 have
    >>> # probabilities 0.9 and 0.8 respectively.
    >>> with e.new_group():
    ...     e.probability = 0.1

.. attribute:: Net.probability
               Vertex.probability
               Experiment.probability

    The probability, between 0.0 and 1.0, of a packet being generated in a
    given timestep.
    
    Default value: 1.0 (Generate a packet every timestep.)
    
    Packet generation is also subject to the burst parameters
    :py:attr:`~Net.burst_period`, :py:attr:`~Net.burst_duty`, and
    :py:attr:`~Net.burst_phase`. By default packets are only generated
    according to :py:attr:`~Net.probability` since bursting behaviour is not
    enabled.

.. attribute:: Net.burst_period
               Net.burst_duty
               Net.burst_phase
               Vertex.burst_period
               Vertex.burst_duty
               Vertex.burst_phase
               Experiment.burst_period
               Experiment.burst_duty
               Experiment.burst_phase

    Set the bursting behaviour of the traffic generated for a net.
    
    Default values: :py:attr:`~Net.burst_period` = 1.0,
    :py:attr:`~Net.burst_duty` = 0.0 and :py:attr:`~Net.burst_phase` = 0.0.
    (Not bursting).
    
    If :py:attr:`~Net.burst_period` is 0.0, packets will be generated each
    timestep with probability :py:attr:`~Net.probability`.
    
    If :py:attr:`~Net.burst_period` is set to a non-zero number of seconds,
    packets may only be generated the proportion of the time specified by
    :py:attr:`~Net.burst_duty`, every :py:attr:`~Net.burst_period` seconds. 
    
    ::
    
        #
        #                            burst_period seconds
        #                     |------------------------------|
        #              (burst_duty * burst_period) seconds
        #                          |-------|
        #       (burst_phase * burst_period) seconds
        #                     |----|
        #                     .                              .
        # maybe send          .    +-------+                 .
        #                     .    |       |                 .
        #                     .    |       |                 .
        # never send    ...---.----+       +-----------------.---...
        #                     .                              .
        #                     .                              .
    
    :py:attr:`~Net.burst_phase` gives the initial phase of the bursting
    behaviour. Note that the phase is not reset at the start of each group.
    
    Special case: If :py:attr:`~Net.burst_phase` is set to None, the phase of
    the bursting behaviour will be chosen randomly.


.. attribute:: Net.use_payload
               Vertex.use_payload
               Experiment.use_payload

    Should a payload field be added to each generated packet?
    
    Default value: False (Generate 40-bit short packets)
    
    If True, 72-bit 'long' multicast packets are generated. If False, 40-bit
    'short' packets are generated.


.. _vertex-attributes:

Vertex
~~~~~~

The following experimental parameters apply to each vertex in the experiment.

The global default for each value can be set by setting the corresponding
:py:class:`Experiment` attribute.

These values may also be overridden on a group-by-group basis.

.. attribute:: Vertex.seed
               Experiment.seed

    The seed for the random number generator in the specified vertex or None to
    select a random seed automatically.
    
    Default value: None (Seed randomly automatically).
    
    If set to a non-None value, the seed is (re)set at the start of each group.

.. attribute:: Vertex.consume_packets
               Experiment.consume_packets

    Should the specified vertex consume packets from the network?
    
    Default value: True (Consume packets from the network)
    
    If set to False, packets sent via any net to the vertex will not be
    consumed from the network. This will cause the packets to back-up in the
    network and eventually cause routers to drop packets.
    
    See also :py:attr:`Experiment.flush_time`.


The :py:class:`Results` Class
`````````````````````````````

.. autoclass:: Results()
    :members:

.. autofunction:: to_csv

The :py:class:`Vertex`, :py:class:`Net` and :py:class:`Group` Classes
`````````````````````````````````````````````````````````````````````

.. autoclass:: Vertex()
    :members:
    
    .. attribute:: name
        
        The human-readable name of this vertex.

.. autoclass:: Net()
    :members:
    
    .. attribute:: name
        
        The human-readable name of this net.
    
    .. attribute:: source
        
        The source vertex of the net.
    
    .. attribute:: sinks
        
        A list of sink vertices for the net.
    
    .. attribute:: weight
        
        The weight placement & routing hint for the net.

.. autoclass:: Group()
    :members:
    
    .. attribute:: name
        
        The human-readable name of this group.

